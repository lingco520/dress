<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.daqsoft.mapper.client.scenicspotinfo.ScenicSpotInfoDao">
    <!--景区资讯-->

    <select id="getInformationss" parameterType="String"
            resultType="com.daqsoft.vo.client.mysqlBean.PlanMountain">
        <![CDATA[

          select s.id,s.name
         from w_navigation_manage as s
          where s.status = 1  AND s.pcode='informationss' AND s.vcode=#{vcode} order by s.id DESC


        ]]>
    </select>

    <!--查询全部-->
    <select id="getAll" parameterType="Map"
            resultType="com.daqsoft.vo.client.mysqlBean.ArticleActivity">
        <![CDATA[

           select s.id,s.title ,date_format(s.publishTime,'%Y-%m-%d %H:%i:%s') as publishTime,s.abstract,image,s.source,s.author
           from w_article_activity as s
           where s.status = 1 AND vcode=#{vcode}
           order by s.id DESC


        ]]>
    </select>
    <!--景区新闻,公告通知,行业动态 -->
    <select id="getType" parameterType="Map"
            resultType="com.daqsoft.vo.client.mysqlBean.ArticleActivity">
        <!--pid=241-->
        <![CDATA[
           select s.id,s.title ,date_format(s.publishTime,'%Y-%m-%d %H:%i:%s') as publishTime,s.abstract,image,s.source,s.author
           from w_article_activity as s
           where s.status =1  AND s.pid=#{pid} AND vcode=#{vcode}
           order by s.id DESC

        ]]>
    </select>

    <!--景区资讯详情-->

    <select id="getDetails" parameterType="Map"
            resultType="com.daqsoft.vo.client.mysqlBean.ArticleActivity">
        <![CDATA[

          select s.id,s.title,date_format(s.publishTime,'%Y-%m-%d %H:%i:%s') as publishTime,s.sketchPicture ,s.activityIntroduction,s.scans ,s.abstract ,s.source, s.author
          from w_article_activity as s
          where s.status =1 AND s.id=#{id} AND vcode=#{vcode}

        ]]>
    </select>
    <!--&lt;!&ndash;统计信息发布，天和总计&ndash;&gt;****老版本华清宫查信息发布，新的信息发布查询在下面-->
    <!--<select id="getInformationCounts" parameterType="Map" resultType="long">-->
            <!--SELECT-->
                <!--COUNT(ID)-->
            <!--FROM-->
                <!--jq_information-->
            <!--WHERE-->
                <!--VCODE = #{vcode}-->
                <!--<if test="date != null and '' != date">-->
                    <!--AND TIME = #{date}-->
                <!--</if>-->
               <!--AND type LIKE '%${type}%'-->
    <!--</select>-->
    <!--统计信息发布，天和总计 **新版信息发布统计**-->
    <select id="getInformationCounts" parameterType="Map" resultType="long">
        select count(*)
        from
        (select s.*,d.DITCH_NAME from jq_information_content s,jq_information_ditch d where s.DITCH_ID=d.ID
        <if test="date != null and '' != date">
            AND DATE_FORMAT(s.PUBLISH_TIME, '%Y-%m-%d') = #{date}
        </if>
        ) a
        where a.DITCH_NAME
        like '%${type}%'
    </select>
    <!--&lt;!&ndash;统计信息发布，年&ndash;&gt; ***老版本的信息发布，新版本华清宫在下面，查询表改变***-->
    <!--<select id="getInformationCountsByYear" parameterType="Map" resultType="long">-->
            <!--SELECT-->
                <!--COUNT(ID)-->
            <!--FROM-->
                <!--jq_information-->
            <!--WHERE-->
                <!--VCODE = #{vcode}-->
                <!--<if test="date != null and '' != date">-->
                    <!--AND DATE_FORMAT(TIME,'%Y') = #{date}-->
                <!--</if>-->
               <!--AND type LIKE '%${type}%'-->
    <!--</select>-->
    <!--统计信息发布，年-->
    <select id="getInformationCountsByYear" parameterType="Map" resultType="long">
        select count(*)
        from
        (select s.*,d.DITCH_NAME from jq_information_content s,jq_information_ditch d where s.DITCH_ID=d.ID
        <if test="date != null and '' != date">
            AND DATE_FORMAT(s.PUBLISH_TIME, '%Y') = #{date}
        </if>
        ) a
        where a.DITCH_NAME
        like '%${type}%'
    </select>
    <!--统计信息发布，年-->
    <select id="getSpotsWifiList" parameterType="map" resultType="com.daqsoft.vo.client.madeVoBean.SpotsWifiVo">
            SELECT
            ass.`name` as spotsName,
            COUNT(jwp.id) as wifiNum
            FROM
                jq_wifi_part jwp,
                jq_wifi_apmac jwa,
                api_scenic_spots ass
            WHERE
                jwp.vcode = #{vcode}
            AND jwp.apMacAddress = jwa.apmac
            AND jwa.scenicId = ass.id
            AND ass.`status` != -99
            AND ass.vcode = #{vcode}
            AND DATE_FORMAT(jwp.addTime,'%Y-%m-%d') = DATE_FORMAT(#{date},'%Y-%m-%d')
            GROUP BY ass.`name`
    </select>
    <!-- 查询景区景点列表 -->
    <select id="getScenicNames" parameterType="String" resultType="String">
            SELECT
                NAME
            FROM
                api_scenic_spots
            WHERE
                vcode = #{vcode}
    </select>
    <!--获取景点的最大承载量 -->
    <select id="getScenicMaxquantity" parameterType="String" resultType="map">
        SELECT t.name as name,t.maxCount as maxquantity from
        (SELECT  b.NAME, a.maxCount FROM jq_scenic_comfort a,api_scenic_spots b where b.id = a.SCENICID
        and a.vcode = #{vcode}
        group by b.NAME,a.maxCount  order by a.maxcount+0 DESC) t group by t.NAME
    </select>

    <!-- 查询景区景点列表 -->
    <select id="getScenicNamesList" parameterType="String" resultType="map">
            select NAME as name,ID as id,PARKING_LOT as parkingTotal from res_parking where vcode = #{vcode} AND `status` != -99
    </select>
    <!-- 查询景区景点最大承载 -->
    <select id="getScenicMaxCounts" parameterType="String" resultType="map">
        SELECT
        s.`name`,
        ifnull(sc.maxCount,0) as maxCount
    FROM
        api_scenic_spots s,
        JQ_SCENIC_COMFORT sc
    WHERE
        s.vcode = #{vcode}
    AND s.id = sc.SCENICID
    AND s.`status` != - 99
    </select>
    <!-- 查询景区景点停车场实时情况，取最近一条记录 -->
    <select id="getParkingInfo" parameterType="map" resultType="com.daqsoft.vo.client.madeVoBean.ParkingVo">
        SELECT
        ifnull(SURPLUS,0) as totalParking,
        ifnull((USED+SURPLUS),0) as maxParkSpace
        FROM
        jq_timely_parking
        WHERE
        VCODE = #{vcode}
        AND PAKING_ID = #{parkid}
        AND TIME BETWEEN #{startTime}
        AND #{endTime}
        ORDER BY
        TIME DESC
        LIMIT 1
    </select>
    <!-- 查询景区景点停车场实时情况，取最近一条记录(新增已使用) -->
    <select id="getParkingNewInfo" parameterType="map" resultType="com.daqsoft.vo.client.madeVoBean.ParkingNewVo">
        SELECT
        ifnull(SURPLUS,0) as totalParking,
        ifnull((USED+SURPLUS),0) as maxParkSpace,
        ifnull(USED,0) as total
        FROM
        jq_timely_parking
        WHERE
        VCODE = #{vcode}
        AND PAKING_ID = #{parkid}
        AND TIME BETWEEN #{startTime}
        AND #{endTime}
        ORDER BY
        TIME DESC
        LIMIT 1
    </select>
    <!-- 查询景区景点停车场累计统计-->
    <select id="getParkingCount" parameterType="map" resultType="Integer">
        SELECT
        COUNT(ID) as count
        FROM
        jq_tvpm_checkout
        WHERE
        VCODE = #{vcode}
        AND ENTRANCETIME BETWEEN #{startTime}
        AND #{endTime}
        <if test="parkid != null and '' != parkid">
            AND PARKID = #{parkid}
        </if>
    </select>

    <!--景区资讯阅读次数-->
    <update id="putScans" parameterType="Map">
        UPDATE w_article_activity s
        set s.scans=#{scans}
        where s.vcode=#{vcode}
        and s.id=#{id}

    </update>


    <select id="getScenicComplaintsAll" parameterType="Map" resultType="com.daqsoft.vo.client.madeVoBean.ComplantsVo">

      SELECT GROUP_CONCAT(tabless.num) as num,GROUP_CONCAT(tabless.TYPE) as name,tabless.dateTime from (
          SELECT COUNT(id) as num,s.TYPE,DATE_FORMAT(s.CREATETIME,#{dateFormat}) as dateTime
          FROM jq_complaints s
          WHERE s.status != -99
          AND s.VCODE = #{vcode}
          AND s.TYPE is NOT NULL
          AND s.CREATETIME BETWEEN #{strTime} and #{endTime}
          GROUP BY s.TYPE,DATE_FORMAT(s.CREATETIME,#{dateFormat})
        ) as tabless GROUP BY tabless.dateTime

    </select>

</mapper>
